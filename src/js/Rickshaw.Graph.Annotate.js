Rickshaw.namespace('Rickshaw.Graph.Annotate');

Rickshaw.Graph.Annotate = function(args) {

	var graph = this.graph = args.graph;
	this.elements = { timeline: args.element };
	
	var self = this;

	this.data = {};

	this.elements.timeline.classList.add('rickshaw_annotation_timeline');

	this.add = function(time, content) {
		self.data[time] = self.data[time] || {'boxes': []};
		self.data[time].boxes.push({content: content});
	};

	this.update = function() {

		Rickshaw.keys(self.data).forEach( function(time) {

			var annotation = self.data[time];
			var left = self.graph.x(time);

			if ((left < 0) || (left > self.graph.x.range()[1])) {
				if (annotation.element) {
					annotation.element.style.display = 'none';
				}
				if (annotation.line) {
					// Hide the line; when it is scrolled back to
					// view, it still may be invisible with display: none
					// if the annotation isn't active.
					annotation.line.style.visibility = 'hidden';
				}
				return;
			}

			if (!annotation.element) {
				var element = annotation.element = document.createElement('div');
				element.classList.add('annotation');
				this.elements.timeline.appendChild(element);
				element.addEventListener('click', function(e) {
					element.classList.toggle('active');
					annotation.line.classList.toggle('active');
				}, false);
					
			}

			annotation.element.style.left = left + 'px';
			annotation.element.style.display = 'block';

			annotation.boxes.forEach( function(box) {

				var element = box.element;

				if (!element) {
					element = box.element = document.createElement('div');
					element.classList.add('content');
					element.innerHTML = box.content;
					annotation.element.appendChild(element);

					annotation.line = document.createElement('div');
					annotation.line.classList.add('annotation_line');
					self.graph.element.appendChild(annotation.line);
				}

				annotation.line.style.left = left + 'px';
				// Set line to be visible (the annotation is in the
				// visible region), but the line may be hidden
				// if the annotation is not active.
				annotation.line.style.visibility = 'visible';
			} );
		}, this );
	};

	this.graph.onUpdate( function() { self.update() } );
};
