name: Node.js CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x, 22.x]

    env:
      FAIL_IF_DIST_MESSAGE: "These files are autogenerated. Please don't include changes to these files in your PR"
      # Set the timezone to Eastern Standard Time since that is what the library expects
      TZ: "America/New_York"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Run tests
      run: npm run coverage

    - name: Run Coveralls
      run: npm run coveralls

    - name: Check for changed dist files
      run: |
        git fetch origin main --depth=1
        # Check for changes in dist files, using grep's exit status directly
        DIST_CHANGED=$(git diff --name-only HEAD origin/main | grep 'rickshaw\(\.min\)\?\.\(js\|css\)' || true)
        if [ -n "$DIST_CHANGED" ]; then
          echo -e "\033[31m${{ env.FAIL_IF_DIST_MESSAGE }}"
          echo -e "\033[31mChanged files:"
          echo "$DIST_CHANGED"
          exit 1
        fi